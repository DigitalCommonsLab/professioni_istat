<!DOCTYPE html>
<!-- saved from url=(0041)https://bl.ocks.org/mbostock/raw/4339083/ -->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style>
body {
  margin: 0;
  padding: 0
}
.node circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 3px;
}

.node text {
  font: 12px sans-serif;
}

.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 2px;
}

#tree {
  position:absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
  border: 1px solid blue
}
</style>
</head>
<body>

<select id="selectId">
  <label>Professione:</label>
  <option value="2.2.2.2.0">2.2.2.2.0 - Cartografi e fotogrammetristi</option>
  <option value="3.1.3.4.0">3.1.3.4.0 - Tecnici elettronici</option>
  <option value="6.2.1.2.0">6.2.1.2.0 - Saldatori e tagliatori a fiamma</option>
  <option value="8.1.1.1.0">8.1.1.1.0 - Venditori ambulanti di beni</option>
</select>

<div id="tree">
</div>

<script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
<script src="https://unpkg.com/underscore@1.9.1/underscore.js"></script>
<script src="https://unpkg.com/d3@3.5.17/d3.min.js"></script>
<script>

var baseUrl = "http://api-test.smartcommunitylab.it/t/sco.cartella/isfol/1.0.0/istatLevel";

// ************** Generate the tree diagram  *****************
var $tree = $('#tree'),
   margin = {top: 0, right: 50,left: 50, bottom: 0}, 
   width = $tree.outerWidth() - margin.right + margin.left,
   height = $tree.outerHeight() - margin.top - margin.bottom,
   circleRadius = 10,
   numLevels = 5;
 
var idCount = 0;

var tree = d3.layout.tree()
 .size([height, width]);

var diagonal = d3.svg.diagonal()
 .projection(function(d) {
  return [d.y, d.x];
});

var svg = d3.select("#tree").append("svg")
 .attr("width", width + margin.right + margin.left)
 .attr("height", height + margin.top + margin.bottom)
 .append("g")
 .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

function update(source,p) {
  
  svg.selectAll("*").remove();

  // Compute the new tree layout.
  var nodes = tree.nodes(source).reverse(),
   links = tree.links(nodes);

  // Normalize for fixed-depth.
  nodes.forEach(function(d) {
    d.y = d.depth * (width/numLevels)// - margin.right;
    //d.x = _.shuffle(_.range(50,height,10)).pop();
    d.x += 40;
  });

  // Declare the nodes
  var node = svg.selectAll("g.node")
   .data(nodes, function(d) {
      return d.id;// || (d.id = ++idCount);
  });

  // Enter the nodes.
  var nodeEnter = node.enter().append("g")
   .attr("class", "node")
   .attr("transform", function(d) { 
      return "translate(" + d.y + "," + d.x + ")";
  });

  nodeEnter.append("circle")
   .attr("r", circleRadius)
   .style("fill", "#fff");

  nodeEnter.append("text")
   .attr("x", function(d) {
      return d.children || d._children ? -20 : 20;
    })
   .attr("dy", ".35em")
   .attr("text-anchor", function(d) { 
      return d.children || d._children ? "end" : "start";
    })
   .text(function(d) {
      return d.id+': '+d.name;
      //return ;
    })
   .style("fill-opacity", 1);

  // Declare the links.
  var link = svg.selectAll("path.link")
   .data(links, function(d) {
      return d.target.id;
  });

  // Enter the links.
  link.enter().insert("path", "g")
   .attr("class", "link")
   .attr("d", diagonal);
}

function reformatJSON(json) {

  if(!json['Entries'])
    return null;

  var ret = [],
      ee = json['Entries']['Entry'];

  for(var e in ee) {
    var o = ee[e];

    o.id = ""+o.id;
    delete o.parent;
    //PATCH API FORMATS
    
    o.name = o['nome'];
    delete o['nome'];
    o.desc = o['descrizione'];
    delete o['descrizione'];
    //descrizione, id
    o.level = o.id.split('.').length;
    //delete o.id;
    o.children = null;
    ret.push(o);
  }
  console.log(ret)
  return ret;
}

function urlLevelById(id) {
  id = id || "";
  var url = baseUrl;

  /*if(id.indexOf('.')===-1)
    url += "";
  else  */
  url += (id ? (id.split('.').length+1)+"/"+id : '1');

  console.log('DATALEVELS URLS',id, url);

  return url;
}

function getIdParent(id) {
  var n = id.split('.');
  if(id.indexOf('.')===-1)
    return '0';
  n.splice(-1);
  return n.join('.');
}

function buildTreeById(id, cb) {

  console.log('buildTreeById', id)

  var n = id.split('.'),
      levelId1 = "",
      levelId2 =  n[0],
      levelId3 = [n[0],n[1]].join('.'),
      levelId4 = [n[0],n[1],n[2]].join('.');

  $.when(
    $.getJSON(urlLevelById(levelId1)),
    $.getJSON(urlLevelById(levelId2)),
    $.getJSON(urlLevelById(levelId3)),
    $.getJSON(urlLevelById(levelId4)),
  ).then(function(l1,l2,l3,l4) {

    var dataLevels = [
        reformatJSON(l1[0]),
        reformatJSON(l2[0]),
        reformatJSON(l3[0]),
        reformatJSON(l4[0])
      ];

    console.log('DATALEVELS', dataLevels);

    var data = {
      id: '0',
      level: 0,
      x0: height / 2,
      y0: 0,
      name: "root",
      children: null
    };

    //var droot = _.clone(data);    
    //data.children = dataLevels[0];
    //droot.children = dataLevels[0];

    function fillTree(d, p) {
      if(dataLevels[ d.level ]) {

        //console.log(d.id, 'parent:'+(p && p.id), getIdParent(d.id) )
        //
        //console.log(dataLevels[ d.level ][0].id)

        if(d.id === getIdParent(dataLevels[ d.level ][0].id)) {
          //d.parent = p;
          d.children = dataLevels[ d.level ];
          d.children.forEach(function(child) {
              fillTree(child, d);
          });

        }
      }
    }

    fillTree(data, {id:'0'});
    update(data);

  /*update({
    "id":"1",
    "name": "Top Level",
    "children": [
      {
        "id":"2",
        "name": "Level 2: A",
        "children": [
          {
            "id":"3",
            "name": "Son of A",
            "children": [
              {
                "id":"4",
                "name": "Son of B"
              },
              {
                "id":"5",
                "name": "Daughter of B"
              }
            ]
          },
          {
            "id":"6",
            "name": "Daughter of A"
          }
        ]
      },
      {
        "id":"7",
        "name": "Level 2: B"
      }
    ]
  });//*/

  });

}

$('#selectId').on('change', function (e) {
  var id = $(this).val();

  buildTreeById(id);

})
.val('3.1.3.4.0').trigger('change');

</script>
</body></html>