<!DOCTYPE html>
<!-- saved from url=(0041)https://bl.ocks.org/mbostock/raw/4339083/ -->
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link href="main.css" rel="stylesheet">
</head>
<body>

<label>Professione:</label>
<select id="selectId">
  <option value="2.2.2.2.0">2.2.2.2.0 - Cartografi e fotogrammetristi</option>
  <option value="3.1.3.4.0">3.1.3.4.0 - Tecnici elettronici</option>
  <option value="6.2.1.2.0">6.2.1.2.0 - Saldatori e tagliatori a fiamma</option>
  <option value="8.1.1.1.0">8.1.1.1.0 - Venditori ambulanti di beni</option>
   <option disabled></option>
  <option value="3.2.1.2.7">3.2.1.2.7 - Educatori professionali</option>
  <option value="2.3.1.1.1">2.3.1.1.1 - Biologi e professioni assimilate</option>
</select>

<div id="tree">
</div>

<script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>
<script src="https://unpkg.com/underscore@1.9.1/underscore.js"></script>
<script src="https://unpkg.com/d3@3.5.17/d3.min.js"></script>
<script src="https://unpkg.com/handlebars@4.0.11/dist/handlebars.min.js"></script>
<script>

var baseUrlLevels = "https://api-test.smartcommunitylab.it/t/sco.cartella/isfol/1.0.0/istatLevel";

$(function() {

d3.selection.prototype.moveToFront = function() {  
  return this.each(function(){
    this.parentNode.appendChild(this);
  });
};
d3.selection.prototype.moveToBack = function() {  
    return this.each(function() { 
        var firstChild = this.parentNode.firstChild; 
        if (firstChild) { 
            this.parentNode.insertBefore(this, firstChild); 
        } 
    });
};

var tmpls = {
		node_tooltip: Handlebars.compile($('#tmpl_tooltip').html())
	};

var tooltip = d3.select("body").append("div") 
	.attr("class", "tooltip")
	.style("opacity", 0);

var $tree = $('#tree'),
	vMargin = 0,
	hMargin = 80,
	margin = {top: vMargin, right: hMargin, left: hMargin, bottom: vMargin}, 
	width = $tree.outerWidth() - margin.right - margin.left,
	height = $tree.outerHeight() - margin.top - margin.bottom,
	circleRadius = 10,
	timeDuration = 100,
	numLevels = 5;
 
var idCounter = 0,
	tooltipOffsetX = -10,
	tooltipOffsetY = 0;

var tree = d3.layout.tree()
	.size([height, width]);

var diagonal = d3.svg.diagonal()
	.projection(function(d) {
		return [d.y, d.x];
	});

var svg = d3.select("#tree").append("svg")
	.attr("width", width + margin.right + margin.left)
	.attr("height", height + margin.top + margin.bottom)
	.append("g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

function draw(source, code) {
  
  svg.selectAll("*").remove();

  var nodes = tree.nodes(source).reverse(),
      links = tree.links(nodes);

  nodes.forEach(function(d) {
    d.y = d.depth * (width/(numLevels+1));
  });

  var node = svg.selectAll("g.node")
  .data(nodes, function(d) {
      return d.id;// || (d.id = ++idCounter);
  });

  var nodeEnter = node.enter().append("g")
	.attr({
  	"transform": function(d) { 
  	    return "translate(" + d.y + "," + d.x + ")";
  	},
  	"class": function(d) {
  
  	  if( d.children || 
          d.id === code ||
  	     (d.level === 5 && getIdParent(code) === d.id)
  	     )
  	    return "node highlight";
  	  else
  	    return "node";   
  	}
	});
  

  nodeEnter.append("circle")
    .attr("r", circleRadius)
    .on("mouseover", function(d) {
      var x = d3.event.pageX,
          y = d3.event.pageY;

      tooltip.transition()
          .duration(timeDuration)
          .style("opacity", 1);

      tooltip.html(tmpls.node_tooltip(d))  
          .style("left", (x - tooltipOffsetX) + "px")   
          .style("top", (y - tooltipOffsetY) + "px");  
    })          
    .on("mouseout", function(d) {   
      tooltip.transition()    
          .duration(timeDuration)    
          .style("opacity", 0); 
    });

  nodeEnter.append("text")
    .attr({
      "dy": ".35em",
      "x": function(d) {
        return d.children || d._children ? -20 : 20;
      },
      "text-anchor": function(d) { 
        return d.children || d._children ? "end" : "start";
      }
    })
    .text(function(d) {
      return d.id+': '+d.name;
    });

  var link = svg.selectAll("path.link")
    .data(links, function(d) {
        return d.target.id;
    });

  link.enter().insert("path", "g")
   .attr({
    "d": diagonal,
    "class": function(d) {

      console.log(d.target.name, getIdParent(code), d.target.id)

      if( d.target.children || 
          d.target.id === code ||
         (d.target.level === 5 && getIdParent(code) === d.target.id)
         )
        return "link highlight";
      else
        return "link";
     }
   });

   svg.selectAll(".highlight").moveToFront();
}

function reformatJSON(json) {

	if(!json['Entries'])
		return null;

	var ret = [],
	ee = json['Entries']['Entry'];

	ee = _.isArray(ee) ? ee : [ee];
	//PATCH API

	for(var e in ee)
	{
		var o = ee[e];

		o.id = ""+o.id;
		delete o.parent;
		//PATCH API FORMATS

		o.name = o['nome'];
		delete o['nome'];
		o.desc = o['descrizione'];
		delete o['descrizione'];
		//descrizione, id
		o.level = o.id.split('.').length;
		//delete o.id;
		o.children = null;
		ret.push(o);
	}
	
	console.log(ret[0].level, ret);

	return ret;
}

function urlLevelByCode(code) {
	var url = baseUrlLevels + (code ? (code.split('.').length+1)+"/"+code : '1');
	console.log(code, url);
	return url;
}

function getIdParent(id) {
	var n = id.split('.');
	if(id.indexOf('.')===-1)
		return '0';
	n.splice(-1);
	return n.join('.');
}

function buildTreeByCode(code, cb) {

	console.log('buildTreeByCode: ', code)

	var n = code.split('.'),
		levelId1 = "",
		levelId2 =  n[0],
		levelId3 = [n[0],n[1]].join('.'),
		levelId4 = [n[0],n[1],n[2]].join('.'),
		levelId5 = [n[0],n[1],n[2],n[3]].join('.');

	$.when(
		$.getJSON(urlLevelByCode(levelId1)),
		$.getJSON(urlLevelByCode(levelId2)),
		$.getJSON(urlLevelByCode(levelId3)),
		$.getJSON(urlLevelByCode(levelId4)),
		$.getJSON(urlLevelByCode(levelId5))
	).then(function(l1,l2,l3,l4,l5) {

		var dataLevels = [
			reformatJSON(l1[0]),
			reformatJSON(l2[0]),
			reformatJSON(l3[0]),
			reformatJSON(l4[0]),
			reformatJSON(l5[0])
		];

		console.log('DATALEVELS', dataLevels);

		var data = {
		  id: '0',
		  level: 0,
		  name: "",
		  children: null
		};

		function fillTree(d, p) {
		  if(dataLevels[ d.level ] && 
		     getIdParent(dataLevels[ d.level ][0].id) === d.id)
		  {

		      d.children = dataLevels[ d.level ];
		      d.children.forEach(function(child) {
		          fillTree(child, d);
		      });
		  }
		}

		fillTree(data, {id:'0'});

		draw(data, code);
	});
}

$('#selectId').on('change', function (e) {
  var code = $(this).val();

  buildTreeByCode(code);

})
.val($('#selectId > option:eq(1)').val()).trigger('change');

});

</script>

<script id="tmpl_tooltip" type="text/x-handlebars-template">
<b class="title">{{#if name}} {{name}} {{else}} <i>unamed</i> {{/if}}</b>
<p class="desc">{{desc}}</p>
</script>

</body>
</html>
